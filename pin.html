<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Record</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>

<body class="bg-gray-100">
    <!-- Change PIN form -->
    <div id="changePinForm"
    class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-500 ease-in-out">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md relative">
        <!-- Cancel Button (X icon) in the top-right corner -->
        <button id="cancelPinBtn"
            class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 transition-colors duration-300">&times;</button>

        <h3 class="text-lg font-semibold text-center text-gray-800 mb-4">Change Transaction PIN</h3>

        <p class="text-sm text-gray-600 mb-6 text-center">
            Ensure your new PIN is secure and keep it private. For your security, never share your PIN with anyone.
        </p>

        <form id="pinForm" class="space-y-6">
            <!-- Old PIN input -->
            <div class="flex flex-col items-center">
                <label for="oldPin" class="text-gray-700 text-sm mb-2">Enter Old PIN</label>
                <div class="flex space-x-2 justify-center">
                    <input type="text" maxlength="1" inputmode="numeric" pattern="\d*"
                        class="pin-box w-10 h-10 text-center text-2xl border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-black text-white"
                        required aria-label="Old PIN digit 1" />
                    <input type="text" maxlength="1" inputmode="numeric" pattern="\d*"
                        class="pin-box w-10 h-10 text-center text-2xl border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-black text-white"
                        required aria-label="Old PIN digit 2" />
                    <input type="text" maxlength="1" inputmode="numeric" pattern="\d*"
                        class="pin-box w-10 h-10 text-center text-2xl border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-black text-white"
                        required aria-label="Old PIN digit 3" />
                    <input type="text" maxlength="1" inputmode="numeric" pattern="\d*"
                        class="pin-box w-10 h-10 text-center text-2xl border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-black text-white"
                        required aria-label="Old PIN digit 4" />
                </div>
            </div>

            <!-- New PIN input -->
            <div class="flex flex-col items-center">
                <label for="newPin" class="text-gray-700 text-sm mb-2">Enter New PIN</label>
                <div class="flex space-x-2 justify-center">
                    <input type="text" maxlength="1" inputmode="numeric" pattern="\d*"
                        class="pin-box w-10 h-10 text-center text-2xl border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-black text-white"
                        required aria-label="New PIN digit 1" />
                    <input type="text" maxlength="1" inputmode="numeric" pattern="\d*"
                        class="pin-box w-10 h-10 text-center text-2xl border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-black text-white"
                        required aria-label="New PIN digit 2" />
                    <input type="text" maxlength="1" inputmode="numeric" pattern="\d*"
                        class="pin-box w-10 h-10 text-center text-2xl border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-black text-white"
                        required aria-label="New PIN digit 3" />
                    <input type="text" maxlength="1" inputmode="numeric" pattern="\d*"
                        class="pin-box w-10 h-10 text-center text-2xl border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-black text-white"
                        required aria-label="New PIN digit 4" />
                </div>
            </div>

            <!-- Confirm New PIN input -->
            <div class="flex flex-col items-center">
                <label for="confirmNewPin" class="text-gray-700 text-sm mb-2">Confirm New PIN</label>
                <div class="flex space-x-2 justify-center">
                    <input type="text" maxlength="1" inputmode="numeric" pattern="\d*"
                        class="pin-box w-10 h-10 text-center text-2xl border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-black text-white"
                        required aria-label="Confirm New PIN digit 1" />
                    <input type="text" maxlength="1" inputmode="numeric" pattern="\d*"
                        class="pin-box w-10 h-10 text-center text-2xl border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-black text-white"
                        required aria-label="Confirm New PIN digit 2" />
                    <input type="text" maxlength="1" inputmode="numeric" pattern="\d*"
                        class="pin-box w-10 h-10 text-center text-2xl border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-black text-white"
                        required aria-label="Confirm New PIN digit 3" />
                    <input type="text" maxlength="1" inputmode="numeric" pattern="\d*"
                        class="pin-box w-10 h-10 text-center text-2xl border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-black text-white"
                        required aria-label="Confirm New PIN digit 4" />
                </div>
            </div>

            <!-- PIN Change Warnings -->
            <div class="text-xs text-gray-500 text-center mt-4">
                <p>Make sure your new PIN is strong but easy to remember.</p>
                <p>Never use common sequences like 1234 or your birthdate.</p>
                <p>By submitting, you agree to keep your PIN secure and private.</p>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submitPinBtn"
                class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-500 w-full transition-colors duration-300 focus:outline-none focus:ring focus:ring-green-400">
                Change PIN
            </button>
        </form>
    </div>
</div>

    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDTkXjNDPdbOeo32CaCkglIy-6nzuszEJM",
            authDomain: "orion-investment-2b141.firebaseapp.com",
            projectId: "orion-investment-2b141",
            storageBucket: "orion-investment-2b141.appspot.com",
            messagingSenderId: "705646524460",
            appId: "1:705646524460:web:92d2e3e1ae2a6c2a862a52"
        };
    
        // Initialize Firebase
        document.addEventListener("DOMContentLoaded", () => {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
    
            // Handle PIN change form submission
            document.getElementById("pinForm").addEventListener("submit", async (e) => {
                e.preventDefault();
                const oldPin = Array.from(document.querySelectorAll('.pin-box')).slice(0, 4).map(input => input.value).join('');
                const newPin = Array.from(document.querySelectorAll('.pin-box')).slice(4, 8).map(input => input.value).join('');
                const confirmPin = Array.from(document.querySelectorAll('.pin-box')).slice(8).map(input => input.value).join('');
    
                // Validate PIN
                if (newPin !== confirmPin) {
                    Toastify({
                        text: "New PIN and confirmation do not match!",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "red",
                    }).showToast();
                    return;
                }
    
                try {
                    // Retrieve user ID from local storage
                    const docId = localStorage.getItem("userDocId"); // Ensure 'userId' is set in local storage
    
                    // Check if docId exists
                    if (!docId) {
                        Toastify({
                            text: "User ID not found in local storage!",
                            duration: 3000,
                            gravity: "top",
                            position: "center",
                            backgroundColor: "red",
                        }).showToast();
                        return;
                    }
    
                    const transactionsRef = db.collection("users").doc(docId);
    
                    // Fetch current transaction details
                    const doc = await transactionsRef.get();
                    if (!doc.exists) {
                        console.error("No such document!");
                        return;
                    }
    
                    const data = doc.data();
                    if (data.transactionPin !== oldPin) { // Use 'transactionPin' here
                        Toastify({
                            text: "Old PIN is incorrect!",
                            duration: 3000,
                            gravity: "top",
                            position: "center",
                            backgroundColor: "red",
                        }).showToast();
                        return;
                    }
    
                    // Update the PIN in Firestore
                    await transactionsRef.update({
                        transactionPin: newPin // Update the 'transactionPin'
                    });
    
                    Toastify({
                        text: "PIN changed successfully!",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "green",
                    }).showToast();
                    setTimeout(() => {
                        window.location.href = "./card.html"
                }, 2000);
                    
                } catch (error) {
                    console.error("Error changing PIN: ", error);
                }
            });
    
            // Cancel button functionality
            document.getElementById("cancelPinBtn").addEventListener("click", () => {
                window.location.href = "./card.html";
            });
        });
    </script>
    
     
</body>

</html>
